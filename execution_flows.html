<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MEL: Work flows</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MEL
   </div>
   <div id="projectbrief">Microthread &amp; Execution library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('execution_flows.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Work flows </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#conditions">Conditions</a></li>
<li><a href="#loops">Loops</a></li>
<li><a href="#flow_chart">Flow chart example</a></li>
</ul>
<h3><a class="anchor" id="introduction"></a>
Introduction</h3>
<p>It's possible to create independent work flows to reuse then or apply them at functions as condition. This is very simple thanks to <em>generic lambdas</em>. The lambda or callable used as a flow will receive an <a class="el" href="classmel_1_1execution_1_1_ex_future.html">ExFuture</a> which serves as the input of any other <em>execution</em> function. Let's start with a simple example, defining two flows: </p><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> ExecutorType&gt; <span class="keywordtype">void</span> _sampleFlows1(ExecutorType ex)</div>
<div class="line">{   </div>
<div class="line">    <span class="keyword">auto</span> th = ThreadRunnable::create();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//create a flow. input parameter is an ExFuture depending on given executor</span></div>
<div class="line">    <span class="keyword">auto</span> flow1 = [](<span class="keyword">auto</span> input)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> input | execution::next(</div>
<div class="line">            [](<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; str)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> str+<span class="stringliteral">&quot; Dani&quot;</span>;</div>
<div class="line">            }</div>
<div class="line">        );</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    th-&gt;fireAndForget([ex,flow1] () <span class="keyword">mutable</span></div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">auto</span> res = mel::tasking::waitForFutureMThread&lt;::mel::core::WaitErrorNoException&gt;(</div>
<div class="line">                execution::launch(ex,[]()</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Hello&quot;</span>s;</div>
<div class="line">                }</div>
<div class="line">            )</div>
<div class="line">            | flow1</div>
<div class="line">            | execution::next([](<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; str)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">return</span>  str + <span class="stringliteral">&quot; Barrientos&quot;</span>;</div>
<div class="line">                }</div>
<div class="line">            )</div>
<div class="line">            | </div>
<div class="line">            [](<span class="keyword">auto</span> input)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> input | execution::next([](<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; str)</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">return</span> str + <span class="stringliteral">&quot;. Bye!!&quot;</span>;</div>
<div class="line">                    }</div>
<div class="line">                );</div>
<div class="line">            }</div>
<div class="line">        );</div>
<div class="line">        <span class="keywordflow">if</span> ( res.isValid())</div>
<div class="line">        {</div>
<div class="line">            text::info(<span class="stringliteral">&quot;Result = {}&quot;</span>,res.value());</div>
<div class="line">        }<span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">try</span></div>
<div class="line">            {</div>
<div class="line">                std::rethrow_exception(res.error());                </div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">catch</span>(...)</div>
<div class="line">            {</div>
<div class="line">                ::text::error(<span class="stringliteral">&quot;Some error occured!!&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">    },0,::tasking::Runnable::killFalse);</div>
<div class="line">}</div>
</div><!-- fragment --><p> Output will be: </p><pre class="fragment">Result = Hello Dani Barrientos. Bye!!
</pre> <h3><a class="anchor" id="conditions"></a>
Conditions</h3>
<p>Besides creating flows for reusability, one important use is for conditions, which are the equivalent to a normal <em>switch</em>, such that a flow is selected based on the previous result in the chain. In the next example a flow is chosen, between two, according to a random number. Both flows are written as lambas local to the function, but any other callbable could be used or lambdas written inline in the code, it's shown this way for clarity.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> ExecutorType&gt; <span class="keywordtype">void</span> _sampleFlowsCondition(ExecutorType ex)</div>
<div class="line">{   </div>
<div class="line">    <span class="keyword">auto</span> th = ThreadRunnable::create();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//create a flow. input paramter is an ExFuture depending on given executor</span></div>
<div class="line">    <span class="keyword">auto</span> flow0 = [](<span class="comment">/*execution::ExFuture&lt;ExecutorType,string&gt; */</span><span class="keyword">auto</span> input)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> input | execution::next(</div>
<div class="line">            [](<span class="keywordtype">int</span> val)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> <span class="stringliteral">&quot;Flow0&quot;</span>;</div>
<div class="line">            }</div>
<div class="line">        );</div>
<div class="line">    };</div>
<div class="line">    <span class="keyword">auto</span> flow1 = [](<span class="keyword">auto</span> input)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> input | execution::next(</div>
<div class="line">            [](<span class="keywordtype">int</span> val)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> <span class="stringliteral">&quot;Flow1&quot;</span>;</div>
<div class="line">            }</div>
<div class="line">        );</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    th-&gt;fireAndForget([ex,flow0,flow1] () <span class="keyword">mutable</span></div>
<div class="line">    {</div>
<div class="line">        srand(time(NULL));</div>
<div class="line">        <span class="keyword">auto</span> res = mel::tasking::waitForFutureMThread&lt;::mel::core::WaitErrorNoException&gt;(</div>
<div class="line">                execution::launch(ex,[]()</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordflow">return</span> rand()%10;</div>
<div class="line">                }</div>
<div class="line">            )</div>
<div class="line">            | execution::condition(</div>
<div class="line">                [](<span class="keywordtype">int</span> val)</div>
<div class="line">                {</div>
<div class="line">                    <span class="keywordtype">int</span> result = val&lt;5?0:1;</div>
<div class="line">                    text::info(<span class="stringliteral">&quot;Input value = {}. Selecting flow {}&quot;</span>,val,result);</div>
<div class="line">                    <span class="keywordflow">return</span> result;</div>
<div class="line">                },</div>
<div class="line">                flow0,flow1</div>
<div class="line">            )</div>
<div class="line">            | execution::next( [](<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; str)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">return</span> str+<span class="stringliteral">&quot; End!&quot;</span>;</div>
<div class="line">            })</div>
<div class="line">            </div>
<div class="line">        );</div>
<div class="line">        <span class="keywordflow">if</span> ( res.isValid())</div>
<div class="line">        {</div>
<div class="line">            text::info(<span class="stringliteral">&quot;Result = {}&quot;</span>,res.value());</div>
<div class="line">        }<span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">try</span></div>
<div class="line">            {</div>
<div class="line">                std::rethrow_exception(res.error());                </div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">catch</span>(...)</div>
<div class="line">            {</div>
<div class="line">                ::text::error(<span class="stringliteral">&quot;Some error occured!!&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">    },0,::tasking::Runnable::killFalse);</div>
<div class="line">}</div>
</div><!-- fragment --><p> And the output, in a concrete execution, is: </p><pre class="fragment">Input value = 3. Selecting flow 0
Result = Flow0 End!
</pre><h3><a class="anchor" id="loops"></a>
Loops</h3>
<p>It's possible to implement iterations as part of an execution flow. This concept shouldn't be confused with <a class="el" href="namespacemel_1_1execution.html#acbcaf139dc87026232b3816d7ecb256e">loop</a> which execute independent iterations in a, possibly, parallel way. The concept introduced here referes to sequential iterations,</p>
<p>This way we can implement non-lineal work flows.</p>
<p>In the next example, a loop creating a random number and showing it in console is reapeated 4 times, doing a <em>microthread wait</em> in each iteration (if used executor allows it) </p><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> ExecutorType&gt; <span class="keywordtype">void</span> _sampleWhile(ExecutorType ex)</div>
<div class="line">{   </div>
<div class="line">    <span class="keyword">auto</span> th = ThreadRunnable::create();</div>
<div class="line"> </div>
<div class="line">    th-&gt;fireAndForget([ex] () <span class="keyword">mutable</span></div>
<div class="line">    {</div>
<div class="line">        srand(time(NULL));</div>
<div class="line">        <span class="keywordtype">int</span> idx = 0;</div>
<div class="line">        <span class="keyword">auto</span> res = mel::tasking::waitForFutureMThread&lt;::mel::core::WaitErrorNoException&gt;(</div>
<div class="line">                execution::start(ex)</div>
<div class="line">                | execution::doWhile( </div>
<div class="line">                    []( <span class="keyword">auto</span> input ) noexcept</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">return</span> input | execution::next( []() noexcept -&gt; <span class="keywordtype">int</span></div>
<div class="line">                        {</div>
<div class="line">                            <span class="keywordflow">return</span> rand()%10;</div>
<div class="line">                        })</div>
<div class="line">                        | execution::next( [](<span class="keywordtype">int</span> v ) noexcept</div>
<div class="line">                        {</div>
<div class="line">                            mel::text::info(<span class="stringliteral">&quot; new value = {}&quot;</span>,v);</div>
<div class="line">                            <span class="keywordflow">if</span> constexpr(execution::ExecutorTraits&lt;decltype(ex)&gt;::has_microthreading)</div>
<div class="line">                            {</div>
<div class="line">                                <a class="code" href="classmel_1_1tasking_1_1_process.html#ae3350d1645cca8cb94f65b1b85dff032">mel::tasking::Process::wait</a>(2500);</div>
<div class="line">                            }</div>
<div class="line">                            <span class="keywordflow">else</span></div>
<div class="line">                                mel::text::info(<span class="stringliteral">&quot;Current executor supports true parallelism. wait not done&quot;</span>);</div>
<div class="line">                        });</div>
<div class="line">                    },</div>
<div class="line">                    [idx]() <span class="keyword">mutable</span> noexcept</div>
<div class="line">                    {</div>
<div class="line">                        <span class="keywordflow">if</span> ( ++idx == 4 )</div>
<div class="line">                            <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">//finish while</span></div>
<div class="line">                        <span class="keywordflow">else</span></div>
<div class="line">                            <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">//continue iterating</span></div>
<div class="line">                    }</div>
<div class="line">                </div>
<div class="line">            )                       </div>
<div class="line">        );</div>
<div class="line">        <span class="keywordflow">if</span> ( res.isValid())</div>
<div class="line">        {</div>
<div class="line">            text::info(<span class="stringliteral">&quot;Finished&quot;</span>);</div>
<div class="line">        }<span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">try</span></div>
<div class="line">            {</div>
<div class="line">                std::rethrow_exception(res.error());                </div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">catch</span>(...)</div>
<div class="line">            {</div>
<div class="line">                ::text::error(<span class="stringliteral">&quot;Some error occured!!&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">    },0,::tasking::Runnable::killFalse);</div>
<div class="line">}</div>
<div class="ttc" id="aclassmel_1_1tasking_1_1_process_html_ae3350d1645cca8cb94f65b1b85dff032"><div class="ttname"><a href="classmel_1_1tasking_1_1_process.html#ae3350d1645cca8cb94f65b1b85dff032">mel::tasking::Process::wait</a></div><div class="ttdeci">static ESwitchResult wait(unsigned int msegs) OPTIMIZE_FLAGS</div></div>
</div><!-- fragment --><h3><a class="anchor" id="flow_chart"></a>
Flow chart example</h3>
<p>TODO PONER UN EJEMPLO PITNANDO UN DIAGRAMA DE FLUJO EN IMPLEMENTARLO </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
