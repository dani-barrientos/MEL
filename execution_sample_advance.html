<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MEL: Advanced example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MEL
   </div>
   <div id="projectbrief">Microthread &amp; Execution library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('execution_sample_advance.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Advanced example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Although the code shown in this section is not really complicated, it's a more real one and allow us to check performance aspects. The goal of this example is simply to calculate the mean of a very big vector. We will have a template function to abstract from execution agent. This is the code: </p><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> ExecutorType&gt; <span class="keywordtype">void</span> _testMeanVector(::<a class="code" href="classmel_1_1execution_1_1_ex_future.html">mel::execution::ExFuture</a>&lt;ExecutorType,vector&lt;double&gt;&gt; fut,tests::BaseTest* test)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">typedef</span> vector&lt;double&gt; VectorType;</div>
<div class="line">    <span class="keywordflow">try</span></div>
<div class="line">    {</div>
<div class="line">        Timer timer;</div>
<div class="line">        uint64_t t0 = timer.getMilliseconds();</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">auto</span> res5 = <a class="code" href="namespacemel_1_1core.html#a6d42aa88f8243f26b4acd1d336288091">mel::core::waitForFutureThread</a>( </div>
<div class="line">        fut</div>
<div class="line">        | <a class="code" href="namespacemel_1_1execution.html#a4d64fe832803619def6318b0f715de49">mel::execution::parallel_convert</a>&lt;std::tuple&lt;double,double,double,double&gt;&gt;(  <span class="comment">//calculate mean in 4 parts @todo ¿cómo podrái devolver este resultado a siguiente funcion?</span></div>
<div class="line">            [](VectorType&amp; v) noexcept</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">double</span> mean = 0.f;</div>
<div class="line">                <span class="keywordtype">size_t</span> tam = v.size()/4;</div>
<div class="line">                <span class="keywordtype">size_t</span> endIdx = tam;</div>
<div class="line">                <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; i &lt; endIdx;++i)</div>
<div class="line">                    mean += v[i];</div>
<div class="line">                mean /= v.size();</div>
<div class="line">                <span class="keywordflow">return</span> mean;</div>
<div class="line">            },</div>
<div class="line">            [](VectorType&amp; v) noexcept</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">double</span> mean = 0.f;</div>
<div class="line">                <span class="keywordtype">size_t</span> tam = v.size()/4;</div>
<div class="line">                <span class="keywordtype">size_t</span> startIdx = tam;</div>
<div class="line">                <span class="keywordtype">size_t</span> endIdx = tam*2;</div>
<div class="line">                <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = startIdx; i &lt; endIdx;++i)</div>
<div class="line">                    mean += v[i];</div>
<div class="line">                mean /= v.size();</div>
<div class="line">                <span class="keywordflow">return</span> mean;</div>
<div class="line">            },</div>
<div class="line">            [](VectorType&amp; v) noexcept</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">double</span> mean = 0.f;</div>
<div class="line">                <span class="keywordtype">size_t</span> tam = v.size()/4;</div>
<div class="line">                <span class="keywordtype">size_t</span> startIdx = tam*2;</div>
<div class="line">                <span class="keywordtype">size_t</span> endIdx = tam*3;</div>
<div class="line">                <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = startIdx; i &lt; endIdx;++i)</div>
<div class="line">                    mean += v[i];</div>
<div class="line">                mean /= v.size();</div>
<div class="line">                <span class="keywordflow">return</span> mean;</div>
<div class="line">            },</div>
<div class="line">            [](VectorType&amp; v) noexcept</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">double</span> mean = 0.f;</div>
<div class="line">                <span class="keywordtype">size_t</span> tam = v.size()/4;</div>
<div class="line">                <span class="keywordtype">size_t</span> startIdx = tam*3;</div>
<div class="line">                <span class="keywordtype">size_t</span> endIdx = v.size();</div>
<div class="line">                <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = startIdx; i &lt; endIdx;++i)</div>
<div class="line">                    mean += v[i];</div>
<div class="line">                mean /= v.size();</div>
<div class="line">                <span class="keywordflow">return</span> mean;</div>
<div class="line">            }</div>
<div class="line">        ) | <a class="code" href="namespacemel_1_1execution.html#a00134f8a177ada6961f5f9927816a961">mel::execution::next</a>( [](std::tuple&lt;double,double,double,double&gt;&amp; means)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">return</span> (std::get&lt;0&gt;(means)+std::get&lt;1&gt;(means)+std::get&lt;2&gt;(means)+std::get&lt;3&gt;(means));</div>
<div class="line">        }));</div>
<div class="line">        uint64_t t1 = timer.getMilliseconds();</div>
<div class="line">        text::info(<span class="stringliteral">&quot;Mean = {}. Time spent = {} seconds&quot;</span>,res5.value(),(<span class="keywordtype">float</span>)((t1-t0)/1000.f));</div>
<div class="line">    }<span class="keywordflow">catch</span>(std::exception&amp; e)</div>
<div class="line">    {</div>
<div class="line">        text::info(<span class="stringliteral">&quot;Error = {}&quot;</span>,e.what());</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aclassmel_1_1execution_1_1_ex_future_html"><div class="ttname"><a href="classmel_1_1execution_1_1_ex_future.html">mel::execution::ExFuture</a></div><div class="ttdoc">Extension of mel::core::Future to apply to executors.</div><div class="ttdef"><b>Definition:</b> ExFuture.h:20</div></div>
<div class="ttc" id="anamespacemel_1_1core_html_a6d42aa88f8243f26b4acd1d336288091"><div class="ttname"><a href="namespacemel_1_1core.html#a6d42aa88f8243f26b4acd1d336288091">mel::core::waitForFutureThread</a></div><div class="ttdeci">::mel::core::WaitResult&lt; T &gt; waitForFutureThread(const mel::core::Future&lt; T &gt; &amp;f, unsigned int msecs=::mel::core::Event::EVENT_WAIT_INFINITE)</div><div class="ttdoc">Wait for a Future from a Thread</div><div class="ttdef"><b>Definition:</b> Thread.h:168</div></div>
<div class="ttc" id="anamespacemel_1_1execution_html_a00134f8a177ada6961f5f9927816a961"><div class="ttname"><a href="namespacemel_1_1execution.html#a00134f8a177ada6961f5f9927816a961">mel::execution::next</a></div><div class="ttdeci">ExFuture&lt; ExecutorAgent, std::invoke_result_t&lt; F, TArg &amp; &gt; &gt; next(ExFuture&lt; ExecutorAgent, TArg &gt; source, F &amp;&amp;f)</div><div class="ttdoc">Attach a functor to execute when input fut is complete Given functor will be executed inf the input E...</div><div class="ttdef"><b>Definition:</b> Executor.h:128</div></div>
<div class="ttc" id="anamespacemel_1_1execution_html_a4d64fe832803619def6318b0f715de49"><div class="ttname"><a href="namespacemel_1_1execution.html#a4d64fe832803619def6318b0f715de49">mel::execution::parallel_convert</a></div><div class="ttdeci">ExFuture&lt; ExecutorAgent, ResultTuple &gt; parallel_convert(ExFuture&lt; ExecutorAgent, TArg &gt; source, FTypes &amp;&amp;... functions)</div><div class="ttdoc">Same as parallel but returning a tuple with the values for each functor So, these functors must retur...</div><div class="ttdef"><b>Definition:</b> Executor.h:410</div></div>
</div><!-- fragment --><p> And from the <em>main</em> function: </p><div class="fragment"><div class="line"><span class="keyword">auto</span> th1 = ThreadRunnable::create(<span class="keyword">true</span>);</div>
<div class="line">execution::Executor&lt;Runnable&gt; exr(th1);</div>
<div class="line"><span class="keyword">typedef</span> vector&lt;double&gt; VectorType;</div>
<div class="line"><span class="keyword">auto</span> initFut = execution::launch(exr,[]()</div>
<div class="line">{               </div>
<div class="line">    constexpr <span class="keywordtype">int</span> vecSize = 10&#39;000&#39;000;</div>
<div class="line">    VectorType v(vecSize);</div>
<div class="line">    <span class="keywordflow">for</span>( <span class="keywordtype">size_t</span> i = 0; i &lt; vecSize;++i)</div>
<div class="line">        v[i] = (std::rand()%20)/3.0; <span class="comment">//to create a double</span></div>
<div class="line">    <span class="keywordflow">return</span> v;</div>
<div class="line">});</div>
<div class="line">core::waitForFutureThread(initFut); <span class="comment">//wait for completion of vector creation to not interfere in time measurement</span></div>
<div class="line"><span class="comment">//plain version</span></div>
<div class="line">text::info(<span class="stringliteral">&quot;vector mean: plain way&quot;</span>);</div>
<div class="line">Timer timer;</div>
<div class="line">uint64_t t0 = timer.getMilliseconds();</div>
<div class="line"><span class="keyword">auto</span> mean = core::waitForFutureThread( initFut | </div>
<div class="line">execution::next([](VectorType&amp; v) noexcept</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">double</span> mean = 0.0;</div>
<div class="line">    <span class="keywordtype">size_t</span> endIdx = v.size();</div>
<div class="line">    <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i = 0; i &lt; endIdx;++i)</div>
<div class="line">        mean+=v[i];</div>
<div class="line">    mean/=v.size();</div>
<div class="line">    <span class="keywordflow">return</span> mean;</div>
<div class="line">}));</div>
<div class="line">uint64_t t1 = timer.getMilliseconds();</div>
<div class="line">mel::text::info(<span class="stringliteral">&quot;Mean = {}. Time spent = {}&quot;</span>,mean.value(),(<span class="keywordtype">float</span>)((t1-t0)/1000.f)); </div>
<div class="line">{       </div>
<div class="line">    parallelism::ThreadPool::ThreadPoolOpts opts;</div>
<div class="line">    opts.threadOpts.schedulerOpts = ProcessScheduler::LockFreeOptions{};</div>
<div class="line">    <span class="keyword">auto</span> myPool = make_shared&lt;parallelism::ThreadPool&gt;(opts);</div>
<div class="line">    parallelism::ThreadPool::ExecutionOpts exopts;</div>
<div class="line">    execution::Executor&lt;parallelism::ThreadPool&gt; extp(myPool);</div>
<div class="line">    extp.setOpts({<span class="keyword">true</span>,<span class="keyword">true</span>});</div>
<div class="line">    text::info(<span class="stringliteral">&quot;vector mean: ThreadPoolExecutor&quot;</span>);</div>
<div class="line">    _testMeanVector( execution::transfer(initFut,extp),test);</div>
<div class="line">}</div>
<div class="line">{</div>
<div class="line">    exr.setOpts({<span class="keyword">true</span>,<span class="keyword">false</span>});</div>
<div class="line">    text::info(<span class="stringliteral">&quot;vector mean: RunnableExecutor&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    _testMeanVector(initFut,test);</div>
<div class="line">}</div>
</div><!-- fragment --><p> In this code, a very big vector is created, and the mean of its values is calculated by:</p><ul>
<li>spliting the vector in 4 parts and calculating the mean on each. this is done in using <a class="el" href="namespacemel_1_1execution.html#a4d64fe832803619def6318b0f715de49">parallel_convert</a> with 4 <em>parallel</em> tasks, each of which returns its own mean, so the full result of this job is a tuple.</li>
<li>passing the previous tuple with <a class="el" href="namespacemel_1_1execution.html#a00134f8a177ada6961f5f9927816a961">next</a> to a callable which sums the four measurements.</li>
</ul>
<p>Also, at first, a plain calculation is done to compare de results. In the concrete machine uses at this moment, the output is: </p><div class="fragment"><div class="line">[2022-04-25 10:15:05.215] [info] vector mean: plain way</div>
<div class="line">[2022-04-25 10:15:05.224] [info] Mean = 3.167751133310629. Time spent = 0.009</div>
<div class="line">[2022-04-25 10:15:05.227] [info] vector mean: <a class="code" href="namespacemel_1_1execution.html#a5e0ddd0955796bd634b11035be2161d7">ThreadPoolExecutor</a></div>
<div class="line">[2022-04-25 10:15:05.232] [info] Mean = 3.1677511333276387. Time spent = 0.004 seconds</div>
<div class="line">[2022-04-25 10:15:05.232] [info] vector mean: <a class="code" href="namespacemel_1_1execution.html#a0c008697e5e12a69ade00e0fd0ae3254">RunnableExecutor</a></div>
<div class="line">[2022-04-25 10:15:05.243] [info] Mean = 3.1677511333276387. Time spent = 0.01 seconds</div>
<div class="ttc" id="anamespacemel_1_1execution_html_a0c008697e5e12a69ade00e0fd0ae3254"><div class="ttname"><a href="namespacemel_1_1execution.html#a0c008697e5e12a69ade00e0fd0ae3254">mel::execution::RunnableExecutor</a></div><div class="ttdeci">Executor&lt; Runnable &gt; RunnableExecutor</div><div class="ttdoc">alias for Executor&lt;Runnable&gt;</div><div class="ttdef"><b>Definition:</b> RunnableExecutor.h:277</div></div>
<div class="ttc" id="anamespacemel_1_1execution_html_a5e0ddd0955796bd634b11035be2161d7"><div class="ttname"><a href="namespacemel_1_1execution.html#a5e0ddd0955796bd634b11035be2161d7">mel::execution::ThreadPoolExecutor</a></div><div class="ttdeci">Executor&lt; ThreadPool &gt; ThreadPoolExecutor</div><div class="ttdoc">alias for Executor&lt;ThreadPool&gt;</div><div class="ttdef"><b>Definition:</b> ThreadPoolExecutor.h:141</div></div>
</div><!-- fragment --><p> The results show two very good news:</p><ul>
<li>using a <a class="el" href="namespacemel_1_1execution.html#a5e0ddd0955796bd634b11035be2161d7">ThreadPoolExecutor</a> is more than double faster than a simple <a class="el" href="namespacemel_1_1execution.html#a0c008697e5e12a69ade00e0fd0ae3254">RunnableExecutor</a>. By default a ThreadPool uses all available cores. In this used machine, the number of cores is 8, so each task in <em>parallel_convert</em> is fully independent. Althoguh apparently this should mean that the code should be 4 times faster, other things can affect performance, mainly cache issues.</li>
<li>the direct way takes almost the same time that the <em>RunnableExecutor</em> way, meaning that the internals of the execution and microthread system is very,very low </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
